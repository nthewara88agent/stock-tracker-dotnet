@page "/cgt"
@inject PortfolioService Portfolio
@inject DevUserService DevUser
@inject CgtService CgtService
@inject PriceCacheService PriceCache

<MudText Typo="Typo.h4" Class="mb-4">CGT Report</MudText>

<MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Refresh"
           OnClick="RefreshPrices" Disabled="_refreshing" Class="mb-4">
    @(_refreshing ? "Refreshing..." : "Refresh Prices")
</MudButton>

@if (_loading)
{
    <MudProgressCircular Indeterminate="true" />
}
else if (_report != null)
{
    <MudGrid Class="mb-4">
        <MudItem xs="12" sm="3">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.subtitle2">Total Capital Gains</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Success">@_report.TotalCapitalGains.ToString("C", _usCulture)</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.subtitle2">Total Capital Losses</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Error">@_report.TotalCapitalLosses.ToString("C", _usCulture)</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.subtitle2">Net Capital Gain</MudText>
                    <MudText Typo="Typo.h5">@_report.NetCapitalGain.ToString("C", _usCulture)</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="3">
            <MudCard>
                <MudCardContent>
                    <MudText Typo="Typo.subtitle2">After 50% Discount</MudText>
                    <MudText Typo="Typo.h5" Color="Color.Primary">@_report.DiscountedGain.ToString("C", _usCulture)</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudTable Items="@_report.Holdings" Dense="true" Hover="true" RowStyleFunc="@RowStyle">
        <HeaderContent>
            <MudTh>Ticker</MudTh>
            <MudTh>Buy Date</MudTh>
            <MudTh>CGT Days Remaining</MudTh>
            <MudTh>Qty</MudTh>
            <MudTh>Buy Price</MudTh>
            <MudTh>Current</MudTh>
            <MudTh>Capital Gain</MudTh>
            <MudTh>Discount</MudTh>
            <MudTh>Taxable</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Ticker</MudTd>
            <MudTd>@context.BuyDate.ToString("yyyy-MM-dd")</MudTd>
            <MudTd>
                @if (context.EligibleForDiscount)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Eligible âœ“</MudChip>
                }
                else
                {
                    <span>@context.CgtDaysRemaining days</span>
                }
            </MudTd>
            <MudTd>@context.Quantity</MudTd>
            <MudTd>@context.BuyPrice.ToString("F2")</MudTd>
            <MudTd>@context.CurrentPrice.ToString("F2")</MudTd>
            <MudTd Style="@(context.CapitalGain >= 0 ? "color:green" : "color:red")">@context.CapitalGain.ToString("C", _usCulture)</MudTd>
            <MudTd>@(context.EligibleForDiscount ? "Yes (50%)" : "No")</MudTd>
            <MudTd>@context.DiscountedGain.ToString("C", _usCulture)</MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private CgtReportDto? _report;
    private bool _loading = true;
    private bool _refreshing = false;
    private string _userId = "";
    private static readonly System.Globalization.CultureInfo _usCulture = System.Globalization.CultureInfo.GetCultureInfo("en-US");

    protected override async Task OnInitializedAsync()
    {
        _userId = await DevUser.GetDevUserIdAsync();
        _report = await Portfolio.GetCgtReport(_userId, CgtService);
        if (_report.Holdings.Any() && _report.Holdings.All(h => h.CurrentPrice == h.BuyPrice))
        {
            await RefreshPrices();
        }
        _loading = false;
    }

    private async Task RefreshPrices()
    {
        _refreshing = true;
        StateHasChanged();
        var holdings = await Portfolio.GetHoldings(_userId);
        var tickers = holdings.Select(h => h.Ticker).Distinct();
        await PriceCache.ForceRefreshAsync(tickers);
        _report = await Portfolio.GetCgtReport(_userId, CgtService);
        _refreshing = false;
    }

    private string RowStyle(CgtHoldingDto item, int index)
    {
        if (item.EligibleForDiscount)
            return "background: rgba(76, 175, 80, 0.12);";
        return "";
    }
}
